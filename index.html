<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOANGKUN STORE - PREMIUM GAMING SHOP</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>

        .logo:hover {
    filter: brightness(1.2); /* Làm logo sáng hơn khi di chuột */
    text-shadow: 0 0 8px var(--primary); /* Tạo hiệu ứng hào quang */
    transition: 0.3s;
}

        footer a:hover {
    color: var(--primary) !important;
    transition: 0.3s;
}

        /* Hiệu ứng chữ lướt sáng Gradient */
.glow-text {
    background: linear-gradient(to right, #ff0000 20%, #ffffff 40%, #ff4d4d 60%, #ff0000 80%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: shine-glow 4s linear infinite;
}

@keyframes shine-glow {
    to { background-position: 200% center; }
}

/* Hiệu ứng dòng chữ phụ bay lên nhẹ nhàng */
.sub-text {
    animation: fadeInUp 1.5s ease-out;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 0.9; transform: translateY(0); }
}

/* Hiệu ứng bo góc và đổ bóng cho ảnh sản phẩm */
.thumb img {
    transition: transform 0.5s ease;
}
.card:hover .thumb img {
    transform: scale(1.1); /* Phóng to nhẹ ảnh khi di chuột vào */
}

/* Làm cho các nút liên hệ (Zalo, FB) rung nhẹ để thu hút sự chú ý */
@keyframes shake {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(5deg); }
    50% { transform: rotate(-5deg); }
    100% { transform: rotate(0deg); }
}
.contact-item {
    animation: shake 2s infinite ease-in-out;
}

        .contact-sidebar {
    position: fixed;
    right: 20px;
    bottom: 80px;
    z-index: 999;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.contact-item {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    color: white;
    text-decoration: none;
    font-size: 24px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: 0.3s;
}

.contact-item:hover {
    transform: scale(1.1) translateX(-5px);
}

.zalo { background: #0068ff; }
.facebook { background: #1877f2; }
.telegram { background: #229ed9; }
        
        :root { --primary: #ff0000; --secondary: #121212; --accent: #ff4d4d; --text: #ffffff; --bg: #050505; --card-bg: #1a1a1a; }
        body { margin: 0; padding: 0; background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; overflow-x: hidden; }
        
        /* Hiệu ứng hạt nền */
        #particleCanvas { position: fixed; top: 0; left: 0; z-index: -1; background: radial-gradient(circle, #1a0000 0%, #050505 100%); }
        
        /* Navigation Bar */
        nav { background: rgba(0, 0, 0, 0.85); border-bottom: 2px solid var(--primary); padding: 15px 0; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(15px); }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .nav-content { display: flex; justify-content: space-between; align-items: center; }
/* Tìm đến dòng 24 và thay bằng đoạn này */
.logo {
    font-size: 26px;
    font-weight: 900;
    text-transform: uppercase;
    animation: rgb-glow 4s infinite linear; /* Thêm dòng này để kích hoạt đổi màu */
}

/* Thêm hiệu ứng chạy màu vào bất kỳ đâu trong thẻ <style> */
@keyframes rgb-glow {
    0% { color: #ff0000; text-shadow: 0 0 15px #ff0000; }
    33% { color: #00ff00; text-shadow: 0 0 15px #00ff00; }
    66% { color: #00ffff; text-shadow: 0 0 15px #00ffff; }
    100% { color: #ff0000; text-shadow: 0 0 15px #ff0000; }
}
        /* Nút bấm xịn */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; }
        .btn-red { background: var(--primary); color: white; box-shadow: 0 0 15px rgba(255, 0, 0, 0.4); }
        .btn-red:hover { background: #ff3333; transform: scale(1.05); }
        
        /* Grid Sản phẩm */
        .shop-title { border-left: 5px solid var(--primary); padding-left: 15px; margin: 40px 0 20px; font-size: 22px; text-transform: uppercase; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .card { background: var(--card-bg); border-radius: 15px; overflow: hidden; border: 1px solid #222; transition: 0.4s; position: relative; }
        .card:hover { transform: translateY(-10px); border-color: var(--primary); box-shadow: 0 10px 30px rgba(255,0,0,0.1); }
        .thumb { height: 180px; width: 100%; }
        .thumb img { width: 100%; height: 100%; object-fit: cover; }
        .card-body { padding: 20px; text-align: center; }
        .price { color: var(--primary); font-size: 22px; font-weight: 800; margin: 10px 0; }

        /* Modal hệ thống */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(10px); }
        .modal-content { background: #151515; padding: 35px; border-radius: 20px; border: 1px solid #333; max-width: 400px; width: 90%; text-align: center; position: relative; }
        .input-group { position: relative; margin-bottom: 15px; text-align: left; }
        .input-group input { width: 100%; padding: 12px 15px; background: #000; border: 1px solid #333; border-radius: 8px; color: #fff; box-sizing: border-box; outline: none; }
        .input-group input:focus { border-color: var(--primary); }
        
        /* Thông báo giả lập */
        .fake-noti { position: fixed; bottom: -100px; left: 20px; background: rgba(20, 20, 20, 0.95); padding: 12px 20px; border-left: 4px solid var(--primary); border-radius: 8px; transition: 0.5s; z-index: 999; display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .fake-noti.show { bottom: 20px; }

        /* Lịch sử mua hàng */
        .history-box { margin-top: 50px; background: #111; padding: 20px; border-radius: 15px; border: 1px solid #222; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #222; }
        th { color: var(--primary); }
        
    </style>
</head>
<body>

    <canvas id="particleCanvas" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;"></canvas>

<div id="wheel-toggle" onclick="toggleWheelModal(true)" style="position: fixed; left: 20px; bottom: 150px; z-index: 998; cursor: pointer; animation: bounce 2s infinite;">
    <div style="background: #ff0000; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px #ff0000; border: 2px solid #fff;">
        <i class="fas fa-gift" style="color: white; font-size: 24px;"></i>
    </div>
</div>

<div id="wheelModal" class="modal" style="display: none; align-items: center; justify-content: center; z-index: 10000; background: rgba(0,0,0,0.85);">
    <div class="modal-content" style="max-width: 450px; width: 95%; background: #fff; border-radius: 25px; overflow: hidden; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.5); font-family: 'Segoe UI', Arial, sans-serif; border: none;">
        
        <div style="background: linear-gradient(135deg, #6e08c1 0%, #a009d1 100%); padding: 35px 20px; text-align: center; color: #fff; position: relative;">
            <h2 style="margin: 0; font-size: 26px; text-transform: uppercase; font-weight: 900; letter-spacing: 1px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">Vòng Quay May Mắn</h2>
            <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">Quay nhanh tay - Nhận ngay quà khủng!</p>
        </div>

        <div style="padding: 25px; text-align: center; background: #fff;">
            <p style="margin: 0; color: #444; font-size: 16px; font-weight: 600;">Lượt free: <span id="free-spins" style="color: #e91e63; font-size: 20px; font-weight: 800;">0</span></p>
            
            <div style="position: relative; width: 300px; height: 300px; margin: 25px auto; padding: 10px; background: #f0f0f0; border-radius: 50%; box-shadow: inset 0 0 15px rgba(0,0,0,0.1), 0 10px 25px rgba(0,0,0,0.15);">
                
                <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); z-index: 30; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.3));">
                    <div style="width: 0; height: 0; border-left: 18px solid transparent; border-right: 18px solid transparent; border-top: 30px solid #ff0000;"></div>
                </div>
                
                <canvas id="wheelCanvas" width="300" height="300" style="border-radius: 50%; background: #fff; box-shadow: 0 0 0 8px #fff; transition: transform 4s cubic-bezier(0.1, 0, 0, 1);"></canvas>
                
                <button onclick="spinWheel()" id="spinBtn" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70px; height: 70px; border-radius: 50%; background: radial-gradient(circle, #ff4b2b 0%, #ff416c 100%); color: #fff; border: 5px solid #fff; font-weight: 900; font-size: 15px; cursor: pointer; z-index: 31; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.1s active {transform: translate(-50%, -50%) scale(0.95)}">QUAY</button>
            </div>

            <div id="wheelResult" style="height: 30px; margin: 15px 0; font-weight: bold; color: #6e08c1; font-size: 18px;"></div>
            
            <button onclick="toggleWheelModal(false)" style="width: 100%; padding: 14px; border: none; border-radius: 12px; background: #f5f5f5; color: #888; font-weight: bold; cursor: pointer; font-size: 15px; transition: background 0.3s;" onmouseover="this.style.background='#eee'" onmouseout="this.style.background='#f5f5f5'">Để sau</button>
        </div>
    </div>
</div>

<nav>
    <div class="container nav-content">
       <div class="logo">
    <a href="index.html" style="text-decoration: none; color: inherit;">
        <h1 style="margin: 0; cursor: pointer;">HOANGKUNSTORE</h1>
    </a>
</div>
        <div id="auth-section">
            <button class="btn btn-red" onclick="showAuth(false)">ĐĂNG NHẬP / ĐĂNG KÝ</button>
        </div>
        <div id="user-section" style="display: none; align-items: center; gap: 15px;">
            <div style="font-size: 14px;">Xin chào, <b id="display-name" style="color:var(--primary)">...</b></div>
            <div style="background: #222; padding: 5px 12px; border-radius: 20px; font-size: 14px;">
                <i class="fas fa-wallet" style="color:#00ff00"></i> <span id="user-balance">0đ</span>
            </div>
            <button class="btn btn-red" style="padding: 5px 10px; font-size: 12px;" onclick="showRecharge()">NẠP</button>
            <i class="fas fa-sign-out-alt" style="cursor:pointer; color: #666;" onclick="logout()"></i>
        </div>
    </div>
</nav>

<div class="container">
   <div class="banner" style="text-align: center; padding: 100px 0; background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://i.postimg.cc/g2bY136T/Website-1024x538.png') center/cover; border-radius: 20px; margin-top: 20px; border: 1px solid #444; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
    <h1 class="glow-text" style="font-size: 65px; margin: 0; letter-spacing: 4px; font-weight: 900; text-transform: uppercase; line-height: 1.2;">
        HOANGKUN STORE
    </h1>
    
    <div style="width: 120px; height: 4px; background: var(--primary); margin: 25px auto; border-radius: 10px; box-shadow: 0 0 20px var(--primary);"></div>
    
    <p class="sub-text" style="color: #ffffff; font-size: 18px; letter-spacing: 1px; opacity: 0.9; text-shadow: 1px 1px 5px rgba(0,0,0,0.5);">
        <i class="fas fa-check-circle" style="color: var(--primary);"></i> 
        HỆ THỐNG SOURCE CODE TỰ ĐỘNG - UY TÍN - BẢO MẬT
        <i class="fas fa-check-circle" style="color: var(--primary);"></i>
    </p>
</div>

    <div class="container" style="margin-top: 40px;">
    <div style="background: rgba(15, 15, 15, 0.95); border: 1px solid #333; border-radius: 20px; padding: 25px; box-shadow: 0 0 25px rgba(255, 0, 0, 0.15);">
        <h2 style="text-align: center; color: #fff; text-transform: uppercase; letter-spacing: 3px; margin-bottom: 25px; font-weight: 800;">
            <i class="fas fa-trophy" style="color: gold; margin-right: 10px;"></i> 
            TOP 10 ĐẠI GIA NẠP NHIỀU
            <i class="fas fa-trophy" style="color: gold; margin-left: 10px;"></i>
        </h2>
        <div class="table-responsive" style="border-radius: 15px; overflow: hidden;">
            <table class="table" style="color: white; margin-bottom: 0;">
                <thead style="background: linear-gradient(90deg, #ff0000, #990000); color: white;">
                    <tr>
                        <th style="text-align: center; width: 80px; border: none;">HẠNG</th>
                        <th style="border: none;">KHÁCH HÀNG</th>
                        <th style="text-align: center; border: none;">SỐ DƯ HIỆN TẠI</th>
                    </tr>
                </thead>
                <tbody id="top-nap-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

    <h2 class="shop-title"><i class="fas fa-fire"></i> Sản phẩm mới nhất</h2>
    <div class="grid" id="productGrid"></div>

   <div id="history-section" class="history-box" style="display:none; border: 1px solid var(--primary); margin-top: 30px;">
    <h3 style="color: var(--primary); text-align: center;"><i class="fas fa-shopping-cart"></i> LỊCH SỬ GIAO DỊCH & KHO CODE</h3>
    <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
        <thead>
            <tr style="background: #222; color: #fff;">
                <th style="width: 30%; padding: 10px; border: 1px solid #333;">Tên Sản Phẩm</th>
                <th style="width: 15%; border: 1px solid #333;">Giá</th>
                <th style="width: 30%; border: 1px solid #333;">Ngày Mua</th>
                <th style="width: 25%; border: 1px solid #333;">Link Tải</th>
            </tr>
        </thead>
        <tbody id="history-body"></tbody>
    </table>
</div>
    
<div id="authModal" class="modal">
    <div class="modal-content">
        <h2 id="authTitle" style="margin-top:0">LOGIN</h2>
        <div class="input-group">
            <label style="font-size: 12px; color: #666;">Tên tài khoản</label>
            <input type="text" id="userInput" placeholder="Gõ tên tài khoản...">
        </div>
        <div class="input-group">
            <label style="font-size: 12px; color: #666;">Mật khẩu</label>
            <input type="password" id="passInput" placeholder="*******">
        </div>
        <div id="regFields" style="display: none;">
            <div class="input-group">
                <label style="font-size: 12px; color: #666;">Xác nhận mật khẩu</label>
                <input type="password" id="confirmInput" placeholder="*******">
            </div>
        </div>
        <button class="btn btn-red" style="width: 100%; margin-top: 10px;" onclick="handleAuth()">XÁC NHẬN</button>
        <p class="auth-switch">
            <span id="switchText">Chưa có tài khoản?</span> 
            <b onclick="toggleAuth()" style="color:var(--primary); cursor:pointer">Bấm vào đây</b>
        </p>o
        <div style="margin-top: 20px; font-size: 13px; color: #444; cursor: pointer;" onclick="closeModal('authModal')">Đóng cửa sổ</div>
    </div>
</div>

<div id="rechargeModal" class="modal">
    <div class="modal-content" style="max-width: 500px; padding: 0; overflow: hidden; background: #fff; border: none; border-radius: 15px;">
        <div style="display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd;">
            <div id="re-tab1" onclick="switchRechargeTab('card')" style="flex: 1; padding: 15px; cursor: pointer; color: #ff4747; font-weight: bold; border-bottom: 3px solid #ff4747; text-align: center;">
                Nạp thẻ
            </div>
            <div id="re-tab2" onclick="switchRechargeTab('top')" style="flex: 1; padding: 15px; cursor: pointer; color: #555; font-weight: bold; text-align: center;">
                Top nạp
            </div>
            <div id="re-tab3" onclick="switchRechargeTab('reward')" style="flex: 1; padding: 15px; cursor: pointer; color: #555; font-weight: bold; text-align: center;">
                Phần thưởng
            </div>
        </div>

        <div id="con-card" style="padding: 20px; display: block;">
            <select id="cardType" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
                <option value="">Chọn nhà mạng</option>
                <option value="VIETTEL">Viettel</option>
                <option value="VINAPHONE">Vinaphone</option>
                <option value="MOBIFONE">Mobifone</option>
            </select>
           <select id="cardValue" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
      <option value="">Chọn mệnh giá</option>
      <option value="10000">10,000đ</option>
      <option value="20000">20,000đ</option>
      <option value="50000">50,000đ</option>
      <option value="100000">100,000đ</option>
      <option value="200000">200,000đ</option>
      <option value="500000">500,000đ</option>
            </select>
            <input type="text" id="cardSeri" placeholder="Nhập số Seri" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
            <input type="text" id="cardPin" placeholder="Nhập mã thẻ" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd;">
            <button class="btn-red" style="width:100%; padding:15px; border-radius:8px; border:none; background:#ff4747; color:#fff; font-weight:bold; cursor:pointer;" onclick="sendCard()">Nạp Ngay</button>
        </div>

        <div id="con-top" style="padding: 20px; display: none; max-height: 350px; overflow-y: auto;">
            <div id="top-recharge-list">
                </div>
        </div>

        <div id="con-reward" style="padding: 20px; display: none; text-align: left;">
            <div style="background: #fff5f5; border-left: 4px solid #ff4747; padding: 15px; border-radius: 5px;">
                <p style="color: #d9534f; font-weight: bold; margin-bottom: 5px;">Đua top nạp tháng 02</p>
                <p style="font-size: 14px; margin: 5px 0;">Top 1: 500.000 VNĐ</p>
                <p style="font-size: 14px; margin: 5px 0;">Top 2: 200.000 VNĐ</p>
                <p style="font-size: 14px; margin: 5px 0;">Top 3: 100.000 VNĐ</p>
            </div>
        </div>

        <div style="padding: 15px; border-top: 1px solid #eee;">
            <button class="btn" style="width: 100%; background: #666; color:#fff;" onclick="closeModal('rechargeModal')">Đóng</button>
        </div>
    </div>
</div>

   <div id="profileModal" class="modal">
    <div class="modal-content" style="max-width: 550px; padding: 0; overflow: hidden; border: none; background: #151515;">
        <div style="display: flex; background: #222; border-bottom: 2px solid var(--primary);">
            <div id="tab1-btn" onclick="switchTab('info')" style="flex: 1; padding: 15px; cursor: pointer; color: var(--primary); font-weight: bold; background: #111; text-align: center;">
                <i class="fas fa-user-circle"></i> THÔNG TIN
            </div>
            <div id="tab2-btn" onclick="switchTab('security')" style="flex: 1; padding: 15px; cursor: pointer; color: #888; font-weight: bold; text-align: center;">
                <i class="fas fa-shield-alt"></i> BẢO MẬT
            </div>
        </div>

        <div id="tab-info" style="padding: 30px; display: block; animation: slideIn 0.3s forwards;">
            <div style="background: #000; padding: 20px; border-radius: 15px; text-align: left; border: 1px solid #333;">
                <p><i class="fas fa-user" style="color:var(--primary); width: 20px;"></i> Tài khoản: <b id="p-username" style="float:right; color:#fff;">...</b></p>
                <p><i class="fas fa-wallet" style="color:#00ff00; width: 20px;"></i> Số dư: <b id="p-balance" style="float:right; color:#00ff00;">0đ</b></p>
                <p><i class="fas fa-envelope" style="color:#5bc0de; width: 20px;"></i> Gmail: <span id="p-email" style="float:right; color:#888;">Chưa cập nhật</span></p>
                <p><i class="fas fa-phone" style="color:#f0ad4e; width: 20px;"></i> SĐT: <span id="p-phone" style="float:right; color:#888;">Chưa cập nhật</span></p>
            </div>
        </div>

        <div id="tab-security" style="padding: 30px; display: none; animation: slideIn 0.3s forwards;">
            <div class="input-group"><input type="email" id="updateEmail" placeholder="Gmail mới (ví dụ: abc@gmail.com)"></div>
            <div class="input-group"><input type="text" id="updatePhone" placeholder="Số điện thoại mới"></div>
            <div style="height: 1px; background: #333; margin: 15px 0;"></div>
            <div class="input-group"><input type="password" id="oldPass" placeholder="Mật khẩu hiện tại"></div>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="password" id="newPass" style="flex:1; padding:12px; background:#000; border:1px solid #333; color:#fff; border-radius:8px;" placeholder="Mật khẩu mới">
                <input type="password" id="confirmNewPass" style="flex:1; padding:12px; background:#000; border:1px solid #333; color:#fff; border-radius:8px;" placeholder="Nhập lại">
            </div>
            <button class="btn btn-red" style="width:100%;" onclick="updateProfile()">CẬP NHẬT NGAY</button>
        </div>

        <div style="padding: 0 30px 30px 30px;">
            <button class="btn" style="width: 100%; background: #222; color: #888; border: 1px solid #333;" onclick="closeModal('profileModal')">ĐÓNG HỒ SƠ</button>
        </div>
    </div>
</div>
    
<div id="fakeNoti" class="fake-noti">
    <i class="fas fa-check-circle" style="color: #00ff00;"></i>
    <span id="fakeNotiText"></span>
</div>

    <script>

    let isSpinning = false; // Thêm dòng này ở đầu file Script
    
    // --- 1. KẾT NỐI FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDqpk71mVDWCP3jk7fxbHZayz92LTheY7g",
        databaseURL: "https://hoangkun-594d0-default-rtdb.firebaseio.com",
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
        

     // --- 1. Hàm chuyển Tab nạp tiền ---
function switchRechargeTab(tab) {
    const tabs = ['card', 'top', 'reward'];
    tabs.forEach(t => {
        const content = document.getElementById('con-' + t);
        const btn = document.getElementById('re-tab' + (tabs.indexOf(t) + 1));
        if(content) content.style.display = (t === tab) ? 'block' : 'none';
        if (btn) {
            btn.style.color = (t === tab) ? '#ff4747' : '#555';
            btn.style.borderBottom = (t === tab) ? '3px solid #ff4747' : 'none';
        }
    });
} // <--- Phải có dấu đóng này

        // --- 2. Hàm mở Modal nạp tiền ---
function showRecharge() {
    const user = localStorage.getItem('hoangUser');
    if (!user) return showAuth(false);
    document.getElementById('rechargeModal').style.display = 'flex';
    switchRechargeTab('card');
} // <--- Phải có dấu đóng này
        
function sendCard() {
    const user = localStorage.getItem('hoangUser');
    const type = document.getElementById('cardType').value;
    const value = document.getElementById('cardValue').value;
    const seri = document.getElementById('cardSeri').value.trim();
    const pin = document.getElementById('cardPin').value.trim();
    
    if(!type || !value || !seri || !pin) {
        return Swal.fire("Lỗi", "Vui lòng nhập đầy đủ thông tin thẻ!", "error");
    }

    // Hiệu ứng "Đang gửi" cho xịn
    Swal.fire({
        title: 'Đang gửi thẻ...',
        didOpen: () => { Swal.showLoading(); }
    });

    // Lưu thông tin thẻ vào nhánh 'card_requests' trên Firebase
    db.ref('card_requests').push({
        username: user,
        cardType: type,
        cardValue: value,
        seri: seri,
        pin: pin,
        status: "pending",
        time: new Date().toLocaleString()
    }).then(() => {
        Swal.fire("Thành công", "Thẻ đã được gửi! Chờ Admin duyệt nhé.", "success");
        closeModal('rechargeModal');
        // Xóa trắng ô nhập để lần sau nạp tiếp
        document.getElementById('cardSeri').value = '';
        document.getElementById('cardPin').value = '';
    }).catch(err => Swal.fire("Lỗi", err.message, "error"));
}
        
        function updateProfile() {
    const user = localStorage.getItem('hoangUser');
    const email = document.getElementById('updateEmail').value.trim();
    const phone = document.getElementById('updatePhone').value.trim();
    const oldP = document.getElementById('oldPass').value;
    const newP = document.getElementById('newPass').value;
    const confirmP = document.getElementById('confirmNewPass').value;

    if(!user) return;

    db.ref('users/' + user).once('value', snapshot => {
        const userData = snapshot.val();
        let updates = {};

        // Xử lý đổi mật khẩu
        if(oldP || newP) {
            if(oldP !== userData.pass) return Swal.fire("Lỗi", "Mật khẩu cũ không chính xác!", "error");
            if(newP.length < 6) return Swal.fire("Lỗi", "Mật khẩu mới quá ngắn!", "warning");
            if(newP !== confirmP) return Swal.fire("Lỗi", "Nhập lại mật khẩu không khớp!", "error");
            updates.pass = newP;
        }

        // Cập nhật Gmail và SĐT
        if(email) updates.email = email;
        if(phone) updates.phone = phone;

        if(Object.keys(updates).length > 0) {
            db.ref('users/' + user).update(updates)
            .then(() => {
                Swal.fire("Thành công", "Thông tin hồ sơ đã được cập nhật!", "success");
                closeModal('profileModal');
            });
        } else {
            Swal.fire("Thông báo", "Vui lòng nhập thông tin cần thay đổi!", "info");
        }
    });
}

        function showProfile() {
    const user = localStorage.getItem('hoangUser');
    if (!user) return showAuth(false); // Nếu chưa đăng nhập thì hiện bảng đăng nhập

    // Lấy dữ liệu từ Firebase để đổ vào bảng Profile
    db.ref('users/' + user).once('value', snapshot => {
        const data = snapshot.val();
        if (data) {
            // Đổ dữ liệu vào các thẻ ID trong Modal
            document.getElementById('p-username').innerText = user.toUpperCase();
            document.getElementById('p-balance').innerText = (data.balance || 0).toLocaleString() + "đ";
            document.getElementById('p-email').innerText = data.email || "Chưa cập nhật";
            document.getElementById('p-phone').innerText = data.phone || "Chưa cập nhật";
            
            // Hiện Modal
            document.getElementById('profileModal').style.display = 'flex';
            // Luôn hiển thị mặt "Thông tin" trước khi mở
            switchTab('info');
        }
    });
}

   // Thay thế đoạn cũ bằng đoạn này:
const products = [
    { id: 1, name: "CODE TRAITYM 1", price: 22000, img: "https://cellphones.com.vn/sforum/wp-content/uploads/2024/03/Huong-dan-tao-code-trai-tim-html-tang-nguoi-than-yeu-nhan-ngay-8-3-3.jpg", link: "https://www.mediafire.com/file/x82cfpep8576y2m/Code_tr%25C3%25A1i_tym_1.zip/file" },
    { id: 2, name: "CODE TRAITYM 2", price: 28000, img: "https://cellphones.com.vn/sforum/wp-content/uploads/2024/03/Huong-dan-tao-code-trai-tim-html-tang-nguoi-than-yeu-nhan-ngay-8-3-9.jpg", link: "https://www.mediafire.com/file/9ouog8a5ot8bbjr/Code_tr%25C3%25A1i_tym_2.zip/file" },
    { id: 3, name: "CODE TRAITYM 3", price: 32000, img: "https://cellphones.com.vn/sforum/wp-content/uploads/2024/03/Huong-dan-tao-code-trai-tim-html-tang-nguoi-than-yeu-nhan-ngay-8-3-13.jpg", link: "https://www.mediafire.com/file/y5koz065nphas87/Code_tr%25C3%25A1i_tym_3.zip/file" },
    { id: 4, name: "CODE WEB SHOP", price: 350000, img: "https://i.postimg.cc/JzmdcN7p/game-title.jpg", link: "https://www.mediafire.com/file/kpd7vqbm7235b46/Code+website+Game.zip/file" },
    { id: 5, name: "CODE GAME BẮN CUNG", price: 60000, img: "https://i.postimg.cc/svBYRYkr/IMG-6222.png", link: "https://www.mediafire.com/file/fppnwb0cye4f8p7/Code_ba%25CC%2586%25CC%2581n_cung.zip/file" },
    { id: 6, name: "CODE WEB MÈO CUTE", price: 75000, img: "https://i.postimg.cc/QKFThDy3/IMG-6223.gif", link: "https://www.mediafire.com/file/tcobfv1lccqrvjb/Code_chu%25CC%2581c_mu%25CC%259B%25CC%2580ng_sinh_nha%25CC%25A3%25CC%2582t_1.zip/file" },
    { id: 7, name: "CODE HIỆU ỨNG RỒNG", price: 69000, img: "https://i.postimg.cc/Czfq2F8R/IMG-6224.gif", link: "https://www.mediafire.com/file/csvufyf40lrz37s/Code_hie%25CC%25A3%25CC%2582u_u%25CC%259B%25CC%2581ng_tro%25CC%2589_chuo%25CC%25A3%25CC%2582t_1.zip/file" },
    { id: 8, name: "CODE HIỆU ỨNG CHUỘT 2", price: 65000, img: "https://i.postimg.cc/K3mMVW6Q/IMG-6225.gif", link: "https://www.mediafire.com/file/rzwparz9rv49icq/Code_Hie%25CC%25A3%25CC%2582u_U%25CC%259B%25CC%2581ng_Chuo%25CC%25A3%25CC%2582t_2.zip/file" },
    { id: 10, name: "Code Thư Tỏ Tình", price: 50000, img: "https://i.postimg.cc/q62Czw4K/IMG-6227.gif", link: "https://www.mediafire.com/file/689n10vjdpsnnfv/Code_Thu%25CC%259B_To%25CC%2589_Ti%25CC%2580nh.zip/file" },
    { id: 11, name: "Code Thiệp Chúc Giáng Sinh", price: 51000, img: "https://i.postimg.cc/3yHJnG5Y/IMG-6228.png", link: "https://www.mediafire.com/file/t914seytwtw0me0/Code_Thu%25CC%259B_Gia%25CC%2581ng_Sinh.zip/file" },
    { id: 12, name: "CODE HIỆU ỨNG CHUỘT 4", price: 63000, img: "https://i.postimg.cc/NKjWYf6d/IMG-6231.gif", link: "https://www.mediafire.com/file/e064bjd9uyb8z75/Code_Hie%25CC%25A3%25CC%2582u_U%25CC%259B%25CC%2581ng_Chuo%25CC%25A3%25CC%2582t_4.zip/file" },
    { id: 13, name: "CODE HIỆU ỨNG CHUỘT 5", price: 58000, img: "https://i.postimg.cc/HrkfHswf/IMG-6232.gif", link: "https://www.mediafire.com/file/6zwm6ew9ygnr1u3/Code_Hie%25CC%25A3%25CC%2582u_U%25CC%259B%25CC%2581ng_Chuo%25CC%25A3%25CC%2582t_5.zip/file" },
    { id: 14, name: "CODE HIỆU ỨNG LOADDING", price: 21000, img: "https://i.postimg.cc/pmLgxXfS/IMG-6233.png", link: "https://www.mediafire.com/file/zgsje7jjri4wh7t/Code_Hie%25CC%25A3%25CC%2582u_U%25CC%259B%25CC%2581ng_Loadding.zip/file" },
    { id: 15, name: "Code Qly Web Trường Học", price: 220000, img: "https://i.postimg.cc/G3B9xytZ/Untitled.png", link: "https://www.mediafire.com/file/xd5x96ia1g6arbv/Code+website+quản+lý+trường+học.zip/file" },
    { id: 16, name: "CODE WEBSITE ", price: 200000, img: "https://i.postimg.cc/DzqnVxw3/Untitled.png", link: "https://www.mediafire.com/file/g65sp328f6xfwvl/Code+website.zip/file" }
];
    function renderProducts() {
        document.getElementById('productGrid').innerHTML = products.map(p => `
            <div class="card">
                <div class="thumb"><img src="${p.img}"></div>
                <div class="card-body">
                    <h3 style="font-size:16px; margin:0;">${p.name}</h3>
                    <div class="price">${p.price.toLocaleString()}đ</div>
                    <button class="btn btn-red" style="width:100%" onclick="buyItem('${p.name}', ${p.price}, '${p.link}')">MUA NGAY</button>
                </div>
            </div>
        `).join('');
    }

    // --- 3. LOGIC TÀI KHOẢN (ĐÃ FIX LỖI) ---
    let isRegisterMode = false;

    function showAuth(isReg) {
        isRegisterMode = isReg;
        updateAuthUI();
        document.getElementById('authModal').style.display = 'flex';
    }

    function toggleAuth() {
        isRegisterMode = !isRegisterMode;
        updateAuthUI();
    }

    function updateAuthUI() {
        document.getElementById('authTitle').innerText = isRegisterMode ? "ĐĂNG KÝ" : "ĐĂNG NHẬP";
        document.getElementById('regFields').style.display = isRegisterMode ? "block" : "none";
        document.getElementById('switchText').innerText = isRegisterMode ? "Đã có tài khoản?" : "Chưa có tài khoản?";
    }

    function handleAuth() {
        const user = document.getElementById('userInput').value.trim().toLowerCase();
        const pass = document.getElementById('passInput').value;

        if(!user || !pass) return Swal.fire("Lỗi", "Vui lòng nhập đầy đủ!", "error");

        if(isRegisterMode) {
            const confirm = document.getElementById('confirmInput').value;
            if(pass !== confirm) return Swal.fire("Lỗi", "Mật khẩu không khớp!", "error");

            db.ref('users/' + user).once('value').then(snap => {
                if(snap.exists()) {
                    Swal.fire("Lỗi", "Tên tài khoản đã tồn tại!", "error");
                } else {
                    db.ref('users/' + user).set({
                        pass: pass,
                        balance: 0,
                        createdAt: new Date().toLocaleString()
                    }).then(() => {
                        Swal.fire("Thành công", "Đăng ký thành công! Hãy đăng nhập.", "success");
                        isRegisterMode = false;
                        updateAuthUI();
                    });
                }
            });
        } else {
            db.ref('users/' + user).once('value').then(snap => {
                const data = snap.val();
                if(data && data.pass === pass) {
                    localStorage.setItem('hoangUser', user);
                    Swal.fire("Chào mừng", "Đăng nhập thành công!", "success").then(() => location.reload());
                } else {
                    Swal.fire("Lỗi", "Sai tài khoản hoặc mật khẩu!", "error");
                }
            });
        }
    }

        // --- 4. QUẢN LÝ TRẠNG THÁI NGƯỜI DÙNG ---
        function checkLogin() {
        const user = localStorage.getItem('hoangUser');
        const userSection = document.getElementById('user-section');
        const authSection = document.getElementById('auth-section');

        if(user && userSection) {
            authSection.style.display = 'none';
            userSection.style.display = 'flex';
            document.getElementById('history-section').style.display = 'block';
            
            // Vẽ lại menu để nút "Trang cá nhân" hoạt động
            userSection.innerHTML = `
                <button onclick="openProfile()" style="background: #333; color: #fff; border: 1px solid #555; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-right: 5px;">
                    <i class="fas fa-user"></i> Trang cá nhân
                </button>
                <span style="color: #fff; margin-right: 10px;">Chào, <b style="color:var(--primary)">${user}</b></span>
                <div style="background: #222; padding: 5px 12px; border-radius: 20px; font-size: 14px; margin-right: 10px;">
                    <i class="fas fa-wallet" style="color:#00ff00"></i> <span id="user-balance">0đ</span>
                </div>
                <button class="btn btn-red" style="padding: 5px 10px; font-size: 12px;" onclick="showRecharge()">NẠP</button>
                <i class="fas fa-sign-out-alt" style="cursor:pointer; color: #666; margin-left:10px" onclick="logout()"></i>
            `;
            
            if(document.getElementById('ck-name')) document.getElementById('ck-name').innerText = user.toUpperCase();
            
            db.ref('users/' + user).on('value', snap => {
                const data = snap.val();
                if(data) {
                    const balance = data.balance || 0;
                    const balEl = document.getElementById('user-balance');
                    if(balEl) balEl.innerText = balance.toLocaleString() + 'đ';
                    localStorage.setItem('hoangBal', balance);
                }
            });
            loadHistory(user);
        }
    }


    // Cấu hình thưởng
const prizes = [
    { label: "1.000đ", value: 1000, color: "#FF5722", weight: 50 },  // Rất dễ trúng (50%)
    { label: "5.000đ", value: 5000, color: "#4CAF50", weight: 10 },  // Khó hơn
    { label: "10.000đ", value: 10000, color: "#2196F3", weight: 5 },  // Khó
    { label: "20.000đ", value: 20000, color: "#E91E63", weight: 2 },  // Rất khó
    { label: "Trắng tay", value: 0, color: "#9E9E9E", weight: 20 },   // Dễ trúng (20%)
    { label: "50.000đ", value: 50000, color: "#FF9800", weight: 1 },  // Cực khó
    { label: "2.000đ", value: 2000, color: "#00BCD4", weight: 12 },  // Trung bình
    { label: "100.000đ", value: 100000, color: "#FFC107", weight: 0.1 } // Tỉ lệ "nhân phẩm" (siêu hiếm)
];

function toggleWheelModal(show) {
    const modal = document.getElementById('wheelModal');
    if (modal) {
        modal.style.display = show ? 'flex' : 'none';
        if (show) {
            // Đợi 150ms để Modal hiện ra xong rồi mới bắt đầu vẽ màu
            setTimeout(() => {
                drawWheel();
                console.log("Đã vẽ lại vòng quay!");
            }, 150);
            
            // Cập nhật lượt free từ Firebase
            const user = localStorage.getItem('hoangUser');
            if(user) {
                db.ref('users/' + user).once('value', s => {
                    if(s.exists()) document.getElementById('free-spins').innerText = s.val().freeSpins || 0;
                });
            }
        }
    }
}

function drawWheel() {
    const canvas = document.getElementById('wheelCanvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const size = canvas.width;
    const center = size / 2;
    const arc = Math.PI / (prizes.length / 2);

    ctx.clearRect(0, 0, size, size); // Xóa sạch để vẽ lại từ đầu

    prizes.forEach((prize, i) => {
       const angle = i * arc - Math.PI / 2;
        
        // Vẽ ô màu (Rất quan trọng)
        ctx.fillStyle = prize.color;
        ctx.beginPath();
        ctx.moveTo(center, center);
        ctx.arc(center, center, center - 5, angle, angle + arc, false);
        ctx.lineTo(center, center);
        ctx.fill(); // Phải có lệnh này mới hiện màu
        
        // Vẽ viền trắng
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 2;
        ctx.stroke();

        // Vẽ chữ phần thưởng
        ctx.save();
        ctx.fillStyle = "#ffffff";
        ctx.translate(center + Math.cos(angle + arc/2) * (center * 0.65), center + Math.sin(angle + arc/2) * (center * 0.65));
        ctx.rotate(angle + arc/2 + Math.PI/2);
        ctx.font = "bold 13px Arial";
        ctx.fillText(prize.label, -ctx.measureText(prize.label).width/2, 0);
        ctx.restore();
    });
}
    
async function spinWheel() {
    const user = localStorage.getItem('hoangUser');
    if(!user) return Swal.fire("Lỗi", "Đăng nhập để quay!", "error");
    if(isSpinning) return;

    // Lấy dữ liệu mới nhất từ Firebase
    const snap = await db.ref('users/' + user).once('value');
    const userData = snap.val();
    let freeSpins = userData.freeSpins || 0;
    let balance = userData.balance || 0;

   // Kiểm tra lượt quay: Chỉ cho phép quay khi có freeSpins (nạp 50k tặng 1)
    if (freeSpins > 0) {
        freeSpins -= 1; 
    } else {
        isSpinning = false; // Reset trạng thái để có thể bấm lại
        return Swal.fire({
            title: "Hết lượt quay!",
            html: `Bạn không còn lượt quay nào.<br><br><b style="color:#e91e63">Quy định:</b> Mỗi <b>50.000đ</b> nạp vào tài khoản sẽ được tặng <b>1 lượt quay</b> miễn phí!`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: '#6e08c1',
            confirmButtonText: "Nạp tiền để lấy lượt",
            cancelButtonText: "Đóng"
        }).then((result) => {
            if (result.isConfirmed) {
                toggleWheelModal(false); // Đóng vòng quay
                // Nếu bạn có hàm mở nạp tiền thì gọi ở đây, ví dụ: showModal('rechargeModal');
            }
        });
    }

    isSpinning = true;
    document.getElementById('spinBtn').disabled = true;
    document.getElementById('wheelResult').innerText = "Đang quay...";
    
    // Cập nhật trừ tiền/lượt ngay để chống gian lận
    await db.ref('users/' + user).update({ balance: balance, freeSpins: freeSpins });
    document.getElementById('free-spins').innerText = freeSpins;

    // Logic tính kết quả dựa trên Weight (Tỉ lệ đã chỉnh)
    let totalWeight = prizes.reduce((sum, p) => sum + (p.weight || 1), 0);
    let randomNum = Math.random() * totalWeight;
    let weightSum = 0;
    let prizeIndex = 0;

    for (let i = 0; i < prizes.length; i++) {
        weightSum += (prizes[i].weight || 1);
        if (randomNum <= weightSum) {
            prizeIndex = i;
            break;
        }
    }

    // Tính toán góc quay (Quay ít nhất 10 vòng + góc dừng)
    const sectorAngle = 360 / prizes.length; 
   // Thêm -90 vào cuối để bù đắp góc lệch giữa Canvas và Kim chỉ
const stopAngle = 360 - (prizeIndex * sectorAngle) - (sectorAngle / 2) - 90;
    const spinAngle = 3600 + stopAngle; 

    const canvas = document.getElementById('wheelCanvas');
    canvas.style.transition = 'transform 4s cubic-bezier(0.1, 0, 0.2, 1)';
    canvas.style.transform = `rotate(${spinAngle}deg)`;

    // Đợi quay xong (4 giây)
    setTimeout(() => {
        isSpinning = false;
        document.getElementById('spinBtn').disabled = false;
        const finalPrize = prizes[prizeIndex];

        // Cộng tiền thưởng
        db.ref('users/' + user).once('value').then(s => {
            const currentBal = s.val().balance || 0;
            db.ref('users/' + user).update({ balance: currentBal + finalPrize.value });
            
            // Hiện thông báo đẹp mắt
            if(finalPrize.value > 0) {
                Swal.fire("Chúc mừng!", `Bạn đã nhận được ${finalPrize.label}`, "success");
            } else {
                Swal.fire("Tiếc quá!", "Chúc bạn may mắn lần sau!", "info");
            }
            document.getElementById('wheelResult').innerText = `Kết quả: ${finalPrize.label}`;
        });

        // Reset nhẹ góc quay để lần sau quay tiếp không bị lỗi
        setTimeout(() => {
            canvas.style.transition = 'none';
            canvas.style.transform = `rotate(${stopAngle}deg)`;
            setTimeout(() => canvas.style.transition = 'transform 4s cubic-bezier(0.1, 0, 0.2, 1)', 50);
        }, 500);
    }, 4000);
}
    
// Cập nhật số lượt free hiển thị
function updateWheelUI(user) {
    db.ref('users/' + user).on('value', snap => {
        const data = snap.val();
        if(data) document.getElementById('free-spins').innerText = data.freeSpins || 0;
    });
}

   function buyItem(name, price, downloadLink) {
    const user = localStorage.getItem('hoangUser');
    if(!user) return showAuth(false);

    const currentBal = parseInt(localStorage.getItem('hoangBal') || 0);
    if(currentBal < price) {
        Swal.fire("Thiếu tiền", "Số dư không đủ!", "warning").then(() => showRecharge());
        return;
    }

    Swal.fire({
        title: 'Xác nhận mua?',
        text: `Mua ${name} với giá ${price.toLocaleString()}đ?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#ff0000',
        confirmButtonText: 'MUA NGAY'
    }).then((result) => {
        if (result.isConfirmed) {
            const newBal = currentBal - price;
            const now = new Date().toLocaleString();

            // Chỉ lưu vào 1 bảng duy nhất là 'history' nhưng có thêm link
            db.ref('history/' + user).push({
                product: name,
                price: price,
                date: now,
                link: downloadLink, // Lưu link vào đây luôn
                status: "Thành công"
            });

// TẶNG LƯỢT QUAY: Cứ mỗi 50.000đ giá trị món hàng được 1 lượt
            let bonusSpins = Math.floor(price / 50000); 

            if (bonusSpins > 0) {
                db.ref('users/' + user).once('value').then(snapshot => {
                    let userData = snapshot.val() || {};
                    let currentFreeSpins = userData.freeSpins || 0;
                    
                    db.ref('users/' + user).update({
                        balance: newBal,
                        freeSpins: currentFreeSpins + bonusSpins
                    });
                    
                    Swal.fire("Thành công", `Bạn đã mua ${name} và được tặng ${bonusSpins} lượt quay!`, "success");
                });
            } else {
                db.ref('users/' + user).update({ balance: newBal });
                Swal.fire("Thành công", `Bạn đã mua ${name} thành công!`, "success");
            }
        } // Kết thúc if (result.isConfirmed)
    }); // Kết thúc .then của Swal
} // Kết thúc function buyItem
            
  function loadHistory(user) {
    db.ref('history/' + user).on('value', snap => {
        const historyBody = document.getElementById('history-body');
        const data = snap.val();
        if(!data) {
            historyBody.innerHTML = '<tr><td colspan="4" style="text-align:center">Chưa có giao dịch nào</td></tr>';
            return;
        }

        let html = '';
        for(let id in data) {
            html = `<tr>
                <td style="color:#fff; padding: 10px; border: 1px solid #333;">${data[id].product}</td>
                <td style="color:var(--primary); border: 1px solid #333;">${(data[id].price || 0).toLocaleString()}đ</td>
                <td style="color:#ccc; font-size: 13px; border: 1px solid #333;">${data[id].date}</td>
                <td style="text-align: center; border: 1px solid #333;">
                    <a href="${data[id].link || '#'}" target="_blank" 
                       style="color:#00ff00; text-decoration:none; font-weight:bold; border:1px solid #00ff00; padding:3px 8px; border-radius:4px; font-size:12px;">
                       <i class="fas fa-download"></i> TẢI VỀ
                    </a>
                </td>
            </tr>` + html;
        }
        historyBody.innerHTML = html;
    });
}

    function logout() { localStorage.removeItem('hoangUser'); location.reload(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
  
    // --- 5. HIỆU ỨNG VÀ TRANG TRÍ ---
    function initParticles() {
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = [];
        for(let i=0; i<60; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                vx: Math.random() - 0.5,
                vy: Math.random() - 0.5
            });
        }
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "rgba(255, 0, 0, 0.2)";
            particles.forEach(p => {
                p.x += p.vx; p.y += p.vy;
                if(p.x < 0 || p.x > canvas.width) p.vx *= -1;
                if(p.y < 0 || p.y > canvas.height) p.vy *= -1;
                ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(animate);
        }
        animate();
    }

    function startFakeNoti() {
        const names = ["Quốc Bảo", "Văn Nam", "Thanh Tùng", "Minh Hằng", "Đức Huy"];
        const prices = ["50,000đ", "200,000đ", "100,000đ", "500,000đ"];
        setInterval(() => {
            const noti = document.getElementById('fakeNoti');
            document.getElementById('fakeNotiText').innerHTML = `Khách hàng <b>${names[Math.floor(Math.random()*names.length)]}</b> vừa nạp thành công ${prices[Math.floor(Math.random()*prices.length)]}`;
            noti.classList.add('show');
            setTimeout(() => noti.classList.remove('show'), 5000);
        }, 12000);
    }

    window.onload = () => {
        initParticles();
        renderProducts();
        checkLogin();
        startFakeNoti();
    };
</script>

    <script>
    const canvas = document.getElementById('particleCanvas');
    if(canvas) {
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particles = [];
        for(let i=0; i<100; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 2 + 1,
                speedY: Math.random() * 1 + 0.5
            });
        }
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
            particles.forEach(p => {
                p.y -= p.speedY;
                if(p.y < 0) p.y = canvas.height;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
            requestAnimationFrame(animate);
        }
        animate();
    }

        function loadBoughtCodes(user) {
    db.ref('bought_codes/' + user).on('value', snap => {
        const data = snap.val();
        const body = document.getElementById('kho-code-body');
        if (!data) return;

        let html = '';
        for (let id in data) {
            html = `<tr>
                <td>${data[id].name}</td>
                <td>${data[id].date}</td>
                <td><a href="${data[id].link}" target="_blank" style="color:#00ff00; text-decoration:none; font-weight:bold;">[TẢI VỀ]</a></td>
            </tr>` + html;
        }
        body.innerHTML = html;
    });
}

        function loadTopTen() {
    db.ref('users').on('value', snap => {
        const users = snap.val();
        if (!users) return;

        let userArray = [];
        for (let username in users) {
            userArray.push({
                name: username,
                balance: users[username].balance || 0
            });
        }

        // Sắp xếp ai nhiều tiền hơn đứng trước
        userArray.sort((a, b) => b.balance - a.balance);

        const top10 = userArray.slice(0, 10);
        let html = '';

        top10.forEach((user, index) => {
            let rank = index + 1;
            let icon = rank;
            let nameColor = "#eee";

            if (index === 0) { icon = '👑'; nameColor = "gold"; }
            else if (index === 1) { icon = '🥈'; nameColor = "silver"; }
            else if (index === 2) { icon = '🥉'; nameColor = "#cd7f32"; }

            html += `
                <tr style="border-bottom: 1px solid #222; background: rgba(255,255,255,0.03);">
                    <td style="text-align: center; font-weight: bold; padding: 12px;">${icon}</td>
                    <td style="font-weight: 600; color: ${nameColor}; padding: 12px;">${user.name}</td>
                    <td style="text-align: center; color: #00ff00; font-weight: bold; padding: 12px;">
                        ${user.balance.toLocaleString()}đ
                    </td>
                </tr>
            `;
        });
        document.getElementById('top-nap-body').innerHTML = html;
    });
}
// Chạy hàm
loadTopTen();

function openProfile() {
    const user = localStorage.getItem('hoangUser');
    if (!user) return typeof showAuth === 'function' ? showAuth(false) : alert("Vui lòng đăng nhập!");

    // 1. Ẩn tất cả nội dung chính của shop để hiện trang cá nhân
    const mainElements = document.querySelectorAll('section, .container-fluid, #main-content, .banner, .shop-title, .grid');
    mainElements.forEach(el => el.style.display = 'none');

    // 2. Hiện khung profile-page
    const profilePage = document.getElementById('profile-page');
    if (profilePage) {
        profilePage.style.display = 'block';
    } else {
        return console.error("Không tìm thấy ID 'profile-page' trong HTML!");
    }

    // 3. Hiển thị tên (hỗ trợ cả thẻ input và thẻ text)
    const pInput = document.getElementById('p-username');
    const pDisplay = document.getElementById('p-username-display');
    if (pInput) pInput.value = user;
    if (pDisplay) pDisplay.innerText = user;

    // 4. Load lịch sử từ Firebase
    db.ref('wallet_history/' + user).limitToLast(20).on('value', snap => {
        const body = document.getElementById('wallet-history-body');
        if (!body) return;
        
        body.innerHTML = '';
        const data = snap.val();
        
        if (!data) {
            body.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#888;">Không có dữ liệu lịch sử</td></tr>';
            return;
        }

        Object.values(data).reverse().forEach(item => {
            const amountColor = item.amount > 0 ? '#00ff00' : '#ff4444';
            const amountPrefix = item.amount > 0 ? '+' : '';
            
            body.innerHTML += `
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 12px; font-size:12px;">${item.date || '---'}</td>
                    <td style="padding: 12px; color:${amountColor}; font-weight:bold;">${amountPrefix}${(item.amount || 0).toLocaleString()}đ</td>
                    <td style="padding: 12px; color:#aaa;">${(item.balanceBefore || 0).toLocaleString()}đ</td>
                    <td style="padding: 12px; color:#fff;">${(item.balanceAfter || 0).toLocaleString()}đ</td>
                    <td style="padding: 12px;"><span style="background:#333; padding:2px 8px; border-radius:10px; font-size:11px;">${item.note || 'Giao dịch'}</span></td>
                </tr>`;
        });
    });
}

function closeProfile() {
    // Cách an toàn nhất: Reload trang để giao diện shop quay về trạng thái ban đầu
    location.reload(); 
}
        
</script>

<div class="contact-sidebar">
    <a href="https://zalo.me/84788265513" target="_blank" class="contact-item zalo">
        <i class="fa-solid fa-comment"></i>
    </a>
    
    <a href="https://facebook.com/nvh12072006" target="_blank" class="contact-item facebook">
        <i class="fa-brands fa-facebook-f"></i>
    </a>

    <a href="https://t.me/@kunmmo2006" target="_blank" class="contact-item telegram">
        <i class="fa-brands fa-telegram"></i>
    </a>
</div>

    <div id="profile-page" style="display: none; background: #f4f6f9; min-height: 100vh; padding: 20px 0;">
    <div class="container" style="max-width: 1100px;">
        <nav style="margin-bottom: 20px; font-size: 14px;">
            <a href="#" onclick="closeProfile()" style="text-decoration:none; color:#333;">Trang chủ</a> 
            <span style="color:#999;"> &gt; Lịch sử giao dịch</span>
        </nav>

        <div style="background: #fff; padding: 25px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <label style="display:block; margin-bottom:5px; font-weight:bold;">Tên của bạn <span style="color:red">*</span></label>
                    <input type="text" id="p-username" disabled style="width:100%; padding:10px; border:1px solid #ddd; background:#f9f9f9;">
                </div>
                <div>
                    <label style="display:block; margin-bottom:5px; font-weight:bold;">Số điện thoại</label>
                    <input type="text" placeholder="Chưa cập nhật" style="width:100%; padding:10px; border:1px solid #ddd;">
                </div>
            </div>
            <div style="margin-top:15px;">
                <label style="display:block; margin-bottom:5px; font-weight:bold;">Mật khẩu mới</label>
                <input type="password" id="p-new-pass" placeholder="Bỏ trống nếu giữ mật khẩu cũ" style="width:100%; padding:10px; border:1px solid #ddd;">
            </div>
            <button class="btn" style="background:#d9534f; color:#fff; margin-top:20px; border:none; padding:10px 25px; border-radius:3px;">
                <i class="fas fa-edit"></i> Cập nhật
            </button>
        </div>

        <div style="background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
            <h4 style="color: #d9534f; margin-bottom: 20px;"><i class="fas fa-file-invoice-dollar"></i> Lịch sử biến động số dư</h4>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left;">Thời gian</th>
                            <th style="padding: 12px; text-align: left;">Số tiền</th>
                            <th style="padding: 12px; text-align: left;">Số dư trước</th>
                            <th style="padding: 12px; text-align: left;">Số dư sau</th>
                            <th style="padding: 12px; text-align: left;">Loại</th>
                        </tr>
                    </thead>
                    <tbody id="wallet-history-body">
                        <tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">Không có dữ liệu</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

    <footer style="background: #0a0a0a; border-top: 2px solid var(--primary); padding: 50px 0 20px; margin-top: 50px;">
    <div class="container">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px;">
            
            <div>
                <a href="#" class="logo" style="text-decoration: none;">HOANGKUN<span>STORE</span></a>
                <p style="color: #888; font-size: 14px; line-height: 1.6; margin-top: 15px;">
                    Chuyên cung cấp các giải pháp Source Code Website, hiệu ứng HTML/CSS chất lượng cao. Hệ thống thanh toán tự động, an toàn và bảo mật.
                </p>
            </div>

            <div>
                <h4 style="color: var(--primary); text-transform: uppercase; margin-bottom: 20px;">Liên kết nhanh</h4>
                <ul style="list-style: none; padding: 0; font-size: 14px; line-height: 2;">
                    <li><a href="#" style="color: #ccc; text-decoration: none;">Trang chủ</a></li>
                    <li><a href="https://zalo.me/84788265513" target="_blank" style="color: #ccc; text-decoration: none;">Hỗ trợ khách hàng</a></li>
                    <li><a href="#" onclick="showRecharge()" style="color: #ccc; text-decoration: none;">Hướng dẫn nạp tiền</a></li>
                </ul>
            </div>

            <div>
                <h4 style="color: var(--primary); text-transform: uppercase; margin-bottom: 20px;">Thông tin liên hệ</h4>
                <div style="font-size: 14px; color: #ccc; display: flex; flex-direction: column; gap: 12px;">
                    <div><i class="fas fa-phone-alt" style="color: var(--primary); width: 20px;"></i> Hotline: 0788.265.513</div>
                    <div><i class="fas fa-envelope" style="color: var(--primary); width: 20px;"></i> Email: nvh12072006@gmail.com</div>
                    <div><i class="fas fa-map-marker-alt" style="color: var(--primary); width: 20px;"></i> Địa chỉ: Hải Phòng, Việt Nam</div>
                    <div style="margin-top: 10px; display: flex; gap: 15px;">
                        <a href="https://facebook.com/nvh12072006" target="_blank" style="color: #fff; font-size: 20px;"><i class="fab fa-facebook-square"></i></a>
                        <a href="https://zalo.me/84788265513" target="_blank" style="color: #fff; font-size: 20px;"><i class="fas fa-comment-dots"></i></a>
                        <a href="https://t.me/@kunmmo2006" target="_blank" style="color: #fff; font-size: 20px;"><i class="fab fa-telegram"></i></a>
                    </div>
                </div>
            </div>

        </div>

        <hr style="border: 0; border-top: 1px solid #222; margin: 40px 0 20px;">
        
        <p style="text-align: center; color: #555; font-size: 12px;">
            &copy; 2024 - 2026 <b>HOANGKUN STORE</b>. All Rights Reserved. Thiết kế bởi <b>Nguyen Viet Hoang</b>
        </p>
    </div>
</footer>

    <div id="wheel-toggle" onclick="toggleWheelModal(true)" style="position: fixed; left: 20px; bottom: 150px; z-index: 998; cursor: pointer; animation: bounce 2s infinite;">
    <div style="background: var(--primary); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px var(--primary); border: 2px solid #fff;">
        <i class="fas fa-gift" style="color: white; font-size: 24px;"></i>
    </div>
    <div style="position: absolute; top: -5px; right: -5px; background: gold; color: #000; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; border: 1px solid #000;">FREE</div>
</div>

<div id="wheelModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 450px; border: 2px solid var(--primary);">
        <h2 style="color: var(--primary); margin-bottom: 5px;">VÒNG QUAY MAY MẮN</h2>
        <p style="font-size: 13px; color: #888;">Lượt free: <span id="free-spins" style="color: gold; font-weight: bold;">0</span> | Lượt tính phí: 10.000đ</p>
        
        <div style="position: relative; width: 280px; height: 280px; margin: 20px auto;">
            <div style="position: absolute; top: -15px; left: 50%; transform: translateX(-50%); z-index: 10; width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid var(--primary);"></div>
            <canvas id="wheelCanvas" width="300" height="300" style="width: 100%; height: 100%; border-radius: 50%; transition: transform 4s cubic-bezier(0.1, 0, 0, 1);"></canvas>
            <button onclick="spinWheel()" id="spinBtn" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; border-radius: 50%; background: #fff; border: 3px solid var(--primary); font-weight: bold; cursor: pointer; z-index: 11; font-size: 10px;">QUAY</button>
        </div>
        
        <div id="wheelResult" style="margin: 10px 0; font-weight: bold; color: #00ff00;"></div>
        <button class="btn btn-red" style="width: 100%; opacity: 0.6;" onclick="toggleWheelModal(false)">ĐÓNG</button>
    </div>
</div>

<div id="profile-page" style="display: none; background: #f4f6f9; min-height: 100vh; padding: 20px 0; position: fixed; top: 0; left: 0; width: 100%; z-index: 10000; overflow-y: auto;">
    <div class="container" style="max-width: 1000px; margin: auto; font-family: sans-serif;">
        <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h4 style="border-left: 5px solid #d9534f; padding-left: 15px; color: #333; margin: 0; text-align: left;">THÔNG TIN TÀI KHOẢN</h4>
            <hr style="border: 0.5px solid #eee; margin: 15px 0;">
            <p style="font-size: 16px; color: #555; text-align: left;">Tên tài khoản: <b id="p-username-display" style="color: #d9534f;">---</b></p>
        </div>

        <div style="background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h4 style="border-left: 5px solid #d9534f; padding-left: 15px; color: #333; margin-bottom: 20px; text-align: left;">LỊCH SỬ BIẾN ĐỘNG SỐ DƯ</h4>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 12px; text-align: left; color: #444;">Thời gian</th>
                            <th style="padding: 12px; text-align: left; color: #444;">Số tiền</th>
                            <th style="padding: 12px; text-align: left; color: #444;">Số dư cuối</th>
                            <th style="padding: 12px; text-align: left; color: #444;">Nội dung</th>
                        </tr>
                    </thead>
                    <tbody id="wallet-history-body" style="color: #333;">
                        <tr><td colspan="4" style="text-align:center; padding:30px; color: #999;">Đang tải lịch sử...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div style="text-align: center; margin-top: 30px;">
            <button onclick="closeProfile()" style="padding: 12px 30px; cursor: pointer; background: #333; color: #fff; border: none; border-radius: 5px; font-weight: bold;">
                <i class="fas fa-arrow-left"></i> QUAY LẠI CỬA HÀNG
            </button>
        </div>
    </div>
</div>
    
<style>
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

    @keyframes pulseBtn {
    0% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 20px rgba(255, 65, 108, 0.6); }
    100% { transform: translate(-50%, -50%) scale(1); }
}

#spinBtn:not(:disabled) {
    animation: pulseBtn 1.5s infinite;
}
    
</style>
    
</body>
</html>
