<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HỒ SƠ CÁ NHÂN - VIP</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary: #ff0000;
            --dark-bg: #000000;
            --card-bg: #111;
        }

        body {
            background: radial-gradient(circle at center, #220000 0%, #000000 100%);
            color: #fff;
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .profile-card {
            background: rgba(20, 20, 20, 0.95);
            width: 100%;
            max-width: 400px;
            border-radius: 20px;
            border: 1px solid rgba(255, 0, 0, 0.3);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.2);
            overflow: hidden;
            position: relative;
        }

        /* Avatar Section */
        .profile-header {
            padding: 30px 20px;
            text-align: center;
            background: linear-gradient(180deg, rgba(100,0,0,0.2) 0%, rgba(0,0,0,0) 100%);
            border-bottom: 1px solid #222;
        }

        .avatar {
            width: 80px; height: 80px;
            background: linear-gradient(135deg, #ff0000, #990000);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex; justify-content: center; align-items: center;
            font-size: 35px; font-weight: bold; color: white;
            border: 3px solid #333;
            box-shadow: 0 0 15px var(--primary);
        }

        .username {
            font-size: 22px; font-weight: 900;
            text-transform: uppercase; margin: 0; color: #fff;
            text-shadow: 0 0 10px rgba(255,0,0,0.6);
        }

        .user-rank {
            font-size: 11px; background: #333; color: #aaa;
            padding: 3px 10px; border-radius: 20px; margin-top: 5px;
            display: inline-block;
        }

        /* Stats Box */
        .stats-row {
            display: flex; gap: 10px; padding: 20px;
        }
        .stat-box {
            background: #1a1a1a; flex: 1; padding: 10px;
            border-radius: 10px; text-align: center;
            border: 1px solid #333;
        }
        .stat-val { font-size: 16px; font-weight: bold; display: block; margin-top: 5px; }
        .text-money { color: #0f0; }
        .text-spin { color: #fc0; }
        .stat-label { font-size: 10px; color: #777; text-transform: uppercase; }

        /* Details List */
        .details-list { padding: 0 20px; }
        .detail-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #222; font-size: 13px;
        }
        .d-label { color: #888; display: flex; align-items: center; gap: 8px; }
        .d-label i { width: 15px; color: var(--primary); }
        .d-val { color: #fff; font-weight: 500; }
        
        .code-tag { 
            background: rgba(255,0,0,0.15); color: #ff3333; 
            padding: 2px 6px; border-radius: 4px; font-weight: bold;
        }
        .not-set { color: #444; font-style: italic; }

        /* Action Buttons */
        .btn-edit {
            background: none; border: none; color: var(--primary);
            font-size: 12px; cursor: pointer; text-decoration: underline;
            width: 100%; text-align: right; padding: 10px 20px;
        }

        .form-area { padding: 20px; }
        .input-box {
            width: 100%; padding: 12px; margin-bottom: 10px;
            background: #111; border: 1px solid #333; color: white;
            border-radius: 8px; box-sizing: border-box; outline: none;
        }
        .input-box:focus { border-color: var(--primary); }
        
        .btn-main {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            background: var(--primary); color: white; font-weight: bold;
            cursor: pointer; text-transform: uppercase; margin-bottom: 10px;
        }
        .btn-group { display: flex; gap: 10px; }
        .btn-sub {
            flex: 1; padding: 10px; border: 1px solid #333; background: #111;
            color: #ccc; border-radius: 8px; cursor: pointer;
        }
        .btn-logout { border-color: #500; color: #f55; }

    </style>
</head>
<body>

    <div class="profile-card">
        <div class="profile-header">
            <div class="avatar" id="avatar-char">?</div>
            <h2 class="username" id="username_display">...</h2>
            <span class="user-rank">Thành Viên VIP</span>
        </div>

        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-label"><i class="fas fa-wallet"></i> Số dư</span>
                <span class="stat-val text-money" id="balance_display">0đ</span>
            </div>
            <div class="stat-box">
                <span class="stat-label"><i class="fas fa-ticket-alt"></i> Lượt quay</span>
                <span class="stat-val text-spin" id="spins_display">0</span>
            </div>
        </div>

        <div class="details-list">
            <div class="detail-item">
                <span class="d-label"><i class="fas fa-id-badge"></i> Mã KH</span>
                <span class="d-val code-tag" id="code_display">Đang tạo...</span>
            </div>
            <div class="detail-item">
                <span class="d-label"><i class="fas fa-envelope"></i> Email</span>
                <span class="d-val" id="email_display">...</span>
            </div>
            <div class="detail-item">
                <span class="d-label"><i class="fas fa-phone"></i> SĐT</span>
                <span class="d-val" id="phone_display">...</span>
            </div>
        </div>
        
        <button class="btn-edit" onclick="openUpdateModal()">
            <i class="fas fa-pen"></i> Cập nhật thông tin
        </button>

        <div class="form-area">
            <h4 style="margin: 0 0 15px 0; color: #ff0000; font-size: 14px; text-transform: uppercase;">
                <i class="fas fa-lock"></i> Đổi mật khẩu
            </h4>
            <input type="password" id="oldPass" class="input-box" placeholder="Mật khẩu cũ">
            <input type="password" id="newPass" class="input-box" placeholder="Mật khẩu mới">
            
            <button class="btn-main" onclick="changePass()">Lưu Thay Đổi</button>
            
            <div class="btn-group">
                <button class="btn-sub" onclick="window.location.href='index.html'">Về Shop</button>
                <button class="btn-sub btn-logout" onclick="logout()">Đăng Xuất</button>
            </div>
        </div>
    </div>

    <script>
        // 1. CẤU HÌNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDqpk71mVDWCP3jk7fxbHZayz92LTheY7g",
            databaseURL: "https://hoangkun-594d0-default-rtdb.firebaseio.com"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 2. LOGIC CHÍNH
        const user = localStorage.getItem('hoangUser');

        function init() {
            if (!user) {
                Swal.fire({title: "Lỗi", text: "Chưa đăng nhập!", icon: "error"})
                .then(() => window.location.href = 'index.html');
                return;
            }

            // Hiển thị tên & Avatar
            document.getElementById('username_display').innerText = user;
            document.getElementById('avatar-char').innerText = user.charAt(0).toUpperCase();

            // Lắng nghe dữ liệu Realtime
            db.ref('users/' + user).on('value', snap => {
                const data = snap.val();
                if(data) {
                    // Tiền & Lượt
                    const bal = data.balance || 0;
                    const spins = data.freeSpins || 0;
                    document.getElementById('balance_display').innerText = bal.toLocaleString('vi-VN') + 'đ';
                    document.getElementById('spins_display').innerText = spins;

                    // Email & Phone
                    const email = data.email ? data.email : '<span class="not-set">Chưa cập nhật</span>';
                    const phone = data.phone ? data.phone : '<span class="not-set">Chưa cập nhật</span>';
                    document.getElementById('email_display').innerHTML = email;
                    document.getElementById('phone_display').innerHTML = phone;

                    // Xử lý MÃ KHÁCH HÀNG (Tự tạo nếu chưa có)
                    let mkh = data.customerId;
                    if(!mkh) {
                        const randomId = Math.floor(1000 + Math.random() * 9000);
                        mkh = "MKH" + randomId;
                        db.ref('users/' + user).update({ customerId: mkh });
                    }
                    document.getElementById('code_display').innerText = mkh;
                }
            });
        }

        // 3. HÀM CẬP NHẬT THÔNG TIN (Email, SĐT)
        async function openUpdateModal() {
            const snap = await db.ref('users/' + user).once('value');
            const data = snap.val() || {};
            
            const { value: formValues } = await Swal.fire({
                title: 'CẬP NHẬT HỒ SƠ',
                html:
                    '<input id="swal-email" class="swal2-input" placeholder="Nhập Email" value="' + (data.email || "") + '">' +
                    '<input id="swal-phone" class="swal2-input" placeholder="Nhập SĐT" value="' + (data.phone || "") + '">',
                focusConfirm: false,
                background: '#222', color: '#fff',
                confirmButtonText: 'Lưu Ngay',
                confirmButtonColor: '#ff0000',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-email').value,
                        document.getElementById('swal-phone').value
                    ]
                }
            });

            if (formValues) {
                db.ref('users/' + user).update({
                    email: formValues[0],
                    phone: formValues[1]
                }).then(() => Swal.fire({title: "Thành công", icon: "success"}));
            }
        }

        // 4. ĐỔI MẬT KHẨU
        function changePass() {
            const oldP = document.getElementById('oldPass').value;
            const newP = document.getElementById('newPass').value;
            if(!oldP || !newP) return Swal.fire("Lỗi", "Vui lòng nhập đủ thông tin!", "warning");

            db.ref('users/' + user).once('value').then(snap => {
                const data = snap.val();
                if(data.pass == oldP) {
                    db.ref('users/' + user).update({ pass: newP });
                    Swal.fire("Thành công", "Đổi mật khẩu thành công!", "success");
                    document.getElementById('oldPass').value = '';
                    document.getElementById('newPass').value = '';
                } else {
                    Swal.fire("Lỗi", "Mật khẩu cũ không đúng!", "error");
                }
            });
        }

        // 5. ĐĂNG XUẤT
        function logout() {
            Swal.fire({
                title: 'Đăng xuất?', icon: 'question',
                showCancelButton: true, confirmButtonText: 'Thoát',
                background: '#222', color: '#fff'
            }).then((res) => {
                if(res.isConfirmed) {
                    localStorage.removeItem('hoangUser');
                    window.location.href = 'index.html';
                }
            });
        }

        // CHẠY HÀM KHỞI TẠO
        init();
    </script>
</body>
</html>
