<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VÒNG QUAY MAY MẮN - VVIP</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: #ff0000; --accent: #ffcc00; --bg: #050505; --wheel-border: 20px solid #1a1a1a; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; overflow: hidden; }
        #particleCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        /* Nút quay lại */
        .back-btn { position: absolute; top: 20px; left: 20px; text-decoration: none; color: white; background: rgba(0,0,0,0.5); padding: 10px 25px; border-radius: 30px; font-weight: bold; border: 2px solid rgba(255, 255, 255, 0.1); transition: 0.3s; z-index: 100; backdrop-filter: blur(5px); display: flex; align-items: center; gap: 10px; }
        .back-btn:hover { background: var(--primary); border-color: var(--primary); box-shadow: 0 0 20px rgba(255,0,0,0.5); transform: translateX(5px); }

        .title { color: var(--primary); text-transform: uppercase; margin-bottom: 30px; text-shadow: 0 0 20px var(--primary), 0 0 40px var(--primary); font-size: 45px; font-weight: 900; letter-spacing: 3px; text-align: center; }

        /* Khung vòng quay */
        .wheel-outer { position: relative; width: 500px; height: 500px; border-radius: 50%; padding: 15px; background: linear-gradient(45deg, #111, #333, #111); box-shadow: 0 0 60px rgba(255, 0, 0, 0.4), inset 0 0 30px rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; }
        .wheel-container { position: relative; width: 100%; height: 100%; border: var(--wheel-border); border-radius: 50%; box-sizing: border-box; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .wheel { width: 100%; height: 100%; border-radius: 50%; position: relative; transition: transform 4s cubic-bezier(0.15, 0, 0.2, 1); background: #fff; border: 5px solid #fff; box-sizing: border-box; overflow: hidden; }
        
        /* Kim chỉ */
        .pointer-container { position: absolute; top: -40px; left: 50%; transform: translateX(-50%); z-index: 20; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); }
        .pointer { width: 60px; height: 70px; background: linear-gradient(to bottom, var(--accent), var(--primary)); clip-path: polygon(50% 100%, 0% 0%, 100% 0%); box-shadow: 0 0 20px var(--accent); }
        
        /* Các ô thưởng - FIX LỖI CẮT CHỮ */
        .segment {
            position: absolute;
            width: 50%; height: 50%;
            top: 50%; left: 50%;
            transform-origin: 0% 0%;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .segment-content {
            position: absolute;
            top: 35%; left: 35%;
            transform: translate(-50%, -50%) rotate(-22.5deg); /* Xoay chữ lại cho thẳng */
            text-align: center; width: 140px;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
        }
        .segment-content i { font-size: 24px; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .segment-content span { font-weight: bold; font-size: 15px; color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); white-space: nowrap; }
        
        /* Màu ô */
        .seg-win { background: linear-gradient(135deg, #d90000, #ff3333); }
        .seg-win i, .seg-win span { color: var(--accent); }
        .seg-lose { background: linear-gradient(135deg, #1a1a1a, #333); }
        .seg-lose i, .seg-lose span { color: #aaa; }

        /* Góc quay các ô */
        .seg-1 { transform: rotate(0deg) skewY(-45deg); }
        .seg-2 { transform: rotate(45deg) skewY(-45deg); }
        .seg-3 { transform: rotate(90deg) skewY(-45deg); }
        .seg-4 { transform: rotate(135deg) skewY(-45deg); }
        .seg-5 { transform: rotate(180deg) skewY(-45deg); }
        .seg-6 { transform: rotate(225deg) skewY(-45deg); }
        .seg-7 { transform: rotate(270deg) skewY(-45deg); }
        .seg-8 { transform: rotate(315deg) skewY(-45deg); }

        /* Nút quay trung tâm */
        .spin-btn-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 30; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 50%; }
        .spin-btn { width: 90px; height: 90px; background: linear-gradient(135deg, #fff, #eee); border-radius: 50%; border: 4px solid var(--primary); font-weight: 900; color: var(--primary); font-size: 18px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3), inset 0 2px 5px rgba(255,255,255,1); transition: 0.3s; outline: none; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .spin-btn:hover:not(:disabled) { background: var(--primary); color: #fff; border-color: var(--accent); transform: scale(1.1); box-shadow: 0 0 30px var(--primary); animation: shake 0.5s infinite; }
        .spin-btn:disabled { background: #333; border-color: #555; color: #888; cursor: not-allowed; transform: scale(1); box-shadow: none; }
        @keyframes shake { 0%, 100% { transform: scale(1.1) rotate(0deg); } 25% { transform: scale(1.1) rotate(3deg); } 75% { transform: scale(1.1) rotate(-3deg); } }
        
        .info { margin-top: 40px; font-size: 20px; color: #ccc; background: rgba(20, 20, 20, 0.8); padding: 15px 40px; border-radius: 50px; border: 2px solid #333; backdrop-filter: blur(10px); display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        #spin-count { color: var(--accent); font-weight: 900; font-size: 26px; text-shadow: 0 0 10px var(--accent); }
    </style>
</head>
<body>

    <canvas id="particleCanvas"></canvas>
    <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> VỀ SHOP</a>
    <h1 class="title">VÒNG QUAY TỶ PHÚ</h1>

    <div class="wheel-outer">
        <div class="pointer-container"><div class="pointer"></div></div>
        <div class="wheel-container">
            <div class="wheel" id="wheel">
                <div class="segment seg-win seg-1"><div class="segment-content"><i class="fas fa-coins"></i><span>10.000đ</span></div></div>
                <div class="segment seg-lose seg-2"><div class="segment-content"><i class="far fa-sad-tear"></i><span>Chúc may mắn</span></div></div>
                <div class="segment seg-win seg-3"><div class="segment-content"><i class="fas fa-coins"></i><span>20.000đ</span></div></div>
                <div class="segment seg-win seg-4"><div class="segment-content"><i class="fas fa-sync-alt spin-icon"></i><span>Thêm lượt</span></div></div>
                <div class="segment seg-win seg-5"><div class="segment-content"><i class="fas fa-money-bill-wave"></i><span>50.000đ</span></div></div>
                <div class="segment seg-lose seg-6"><div class="segment-content"><i class="far fa-sad-tear"></i><span>Chúc may mắn</span></div></div>
                <div class="segment seg-win seg-7"><div class="segment-content"><i class="fas fa-gem"></i><span>100.000đ</span></div></div>
                <div class="segment seg-lose seg-8"><div class="segment-content"><i class="far fa-sad-tear"></i><span>Chúc may mắn</span></div></div>
            </div>
        </div>
        <div class="spin-btn-container">
            <button class="spin-btn" id="btnSpin" onclick="spin()">
                <i class="fas fa-play" style="font-size: 24px; margin-bottom: 5px;"></i> QUAY
            </button>
        </div>
    </div>

    <div class="info"><i class="fas fa-ticket-alt" style="color: var(--accent);"></i> Bạn còn: <span id="spin-count">...</span> lượt quay</div>

    <script>
        // Hiệu ứng hạt nền
        const canvas = document.getElementById('particleCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = [];
        for(let i=0; i<80; i++) particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, size: Math.random()*2+1, speedY: Math.random()*1+0.5 });
        function animateParticles() {
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='rgba(255,0,0,0.3)';
            particles.forEach(p => { p.y-=p.speedY; if(p.y<0) p.y=canvas.height; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); });
            requestAnimationFrame(animateParticles);
        }
        animateParticles();
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });

        // Firebase & Logic
        const firebaseConfig = { apiKey: "AIzaSyDqpk71mVDWCP3jk7fxbHZayz92LTheY7g", databaseURL: "https://hoangkun-594d0-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentSpins = 0;
        let isSpinning = false;
        const user = localStorage.getItem('hoangUser');

        if(!user) {
            Swal.fire({ title: "Chưa đăng nhập!", text: "Vui lòng đăng nhập để quay thưởng.", icon: "warning", confirmButtonColor: "#ff0000", confirmButtonText: "Về trang chủ" })
            .then(() => window.location.href='index.html');
        } else {
            db.ref('users/' + user).on('value', snap => {
                const data = snap.val();
                currentSpins = data.freeSpins || 0;
                document.getElementById('spin-count').innerText = currentSpins;
                document.getElementById('btnSpin').disabled = (currentSpins <= 0 || isSpinning);
            });
        }

        // --- CẤU HÌNH TỈ LỆ (TỔNG = 100) ---
        const rewards = [
            { type: 'miss', angle: 315, chance: 20 }, // Hụt (Seg 2)
            { type: 'miss', angle: 135, chance: 20 }, // Hụt (Seg 6)
            { type: 'miss', angle: 45,  chance: 20 }, // Hụt (Seg 8)
            { type: '10k',  angle: 0,   chance: 20 }, // 10k (Seg 1)
            { type: 'spin', angle: 225, chance: 10 }, // Thêm lượt (Seg 4)
            { type: '20k',  angle: 270, chance: 9 },  // 20k (Seg 3)
            { type: '50k',  angle: 180, chance: 0.9 },// 50k (Seg 5) - Siêu khó
            { type: '100k', angle: 90,  chance: 0.1 } // 100k (Seg 7) - Cực phẩm
        ];

        function spin() {
            if(currentSpins <= 0) return Swal.fire({ title: "Hết lượt quay!", text: "Mua thêm sản phẩm (>50k) để nhận lượt quay nhé!", icon: "info", confirmButtonColor: "#ff0000" });
            if(isSpinning) return;

            isSpinning = true;
            document.getElementById('btnSpin').disabled = true;
            db.ref('users/' + user).update({ freeSpins: currentSpins - 1 });

            // Random giải thưởng dựa trên tỉ lệ (Weighted Random)
            let rand = Math.random() * 100;
            let cumulative = 0;
            let target = rewards[0];

            for(let item of rewards) {
                cumulative += item.chance;
                if(rand <= cumulative) {
                    target = item;
                    break;
                }
            }

            // Tính góc quay (quay ít nhất 10 vòng)
            // Thêm random +/- 15 độ để kim không chỉ thẳng đuột vào giữa ô
            const extraDeg = Math.floor(Math.random() * 30) - 15; 
            const totalDeg = 3600 + target.angle + extraDeg;

            const wheel = document.getElementById('wheel');
            wheel.style.transform = `rotate(${totalDeg}deg)`;

            setTimeout(() => {
                isSpinning = false;
                document.getElementById('btnSpin').disabled = false;
                
                // Chuẩn hóa góc về 0-360 để kiểm tra kết quả
                let finalDeg = totalDeg % 360;
                if(finalDeg < 0) finalDeg += 360;
                checkReward(finalDeg);
            }, 4000);
        }

        function checkReward(deg) {
            let prize = "", money = 0, bonusSpin = 0, icon = "";
            
            // Logic mapping góc quay ra giải thưởng (dựa trên góc kim chỉ)
            if (deg >= 0 && deg < 22.5) { prize = "10.000đ"; money = 10000; icon = "coins"; }
            else if (deg >= 22.5 && deg < 67.5) { prize = "Chúc may mắn lần sau"; icon = "sad-tear"; }
            else if (deg >= 67.5 && deg < 112.5) { prize = "100.000đ"; money = 100000; icon = "gem"; }
            else if (deg >= 112.5 && deg < 157.5) { prize = "Chúc may mắn lần sau"; icon = "sad-tear"; }
            else if (deg >= 157.5 && deg < 202.5) { prize = "50.000đ"; money = 50000; icon = "money-bill-wave"; }
            else if (deg >= 202.5 && deg < 247.5) { prize = "Thêm 1 lượt quay"; bonusSpin = 1; icon = "sync-alt"; }
            else if (deg >= 247.5 && deg < 292.5) { prize = "20.000đ"; money = 20000; icon = "coins"; }
            else if (deg >= 292.5 && deg < 337.5) { prize = "Chúc may mắn lần sau"; icon = "sad-tear"; }
            else if (deg >=
